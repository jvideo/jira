type: install
appVersion: latest
id: jira-software
name: Jira Project & Issue Tracking System
logo: /images/jira-logo-new.png
baseUrl: https://raw.githubusercontent.com/vlobzakov/jira/master

categories:
- apps/dev-and-admin-tools

description:
  text: /texts/description.md
  short: Jira Ticketing System

settings:
  
  fields:
  - type: checkbox
    caption: External Database. Recommended for production mode.
    name: db
    value: true
    hideLabel: false
  - name: jiraversion
    type: radio-fieldset
    values:
      long-term-support: Latest <a href="https://confluence.atlassian.com/enterprise/atlassian-enterprise-releases-948227420.html">Long Term Support</a> release 8.5.6
      latest: Latest release 8.11.0
    default: latest
    
globals:
  DB_NAME: jiradb
  version: ${settings.jiraversion}
  
ssl: true

nodes:
- count: 1
  cloudlets: 20
  nodeType: javaengine
  nodeGroup: cp
  extip: false
  startService: false

onInstall:
  - if ('${settings.db}' == 'true'): 
      - addDBnode
      - setGlobals:
          success: success-w-db.md
    elif ('${settings.db}' == 'false'): 
      - setGlobals:
          success: success-no-db.md
  - downloadJira
  - fontconfigInstall
  - setupJira
  - createDB
    
actions:
  addDBnode:
    - addNodes:
        cloudlets: 12
        nodeType: postgresql
        count: 1
  

  downloadJira:
    - if ('${globals.version}' == 'long-term-support'):
        cmd [cp]: |-
          wget -qO /home/jelastic/jira.bin https://product-downloads.atlassian.com/software/jira/downloads/atlassian-jira-software-8.5.6-x64.bin
    - if ('${globals.version}' == 'latest'):
        cmd [cp]: |-
          wget -qO /home/jelastic/jira.bin https://product-downloads.atlassian.com/software/jira/downloads/atlassian-jira-software-8.11.0-x64.bin
      
  fontconfigInstall:
    cmd [cp]: |-
      chmod a+x /home/jelastic/jira.bin
      yum install -y fontconfig
      yum install -y dejavu-sans-fonts
    user: root
     
  setupJira:
    cmd [cp]: |-
      exp_internal 1
      expect -c '
      spawn /home/jelastic/jira.bin
      expect "OK \[o, Enter\], Cancel \[c\]"
      send "o\r"
      expect "Express Install (use default settings) \[1\], Custom Install (recommended for advanced users) \[2, Enter\], Upgrade an existing Jira installation \[3\]" 
      send "1\r"
      expect "Install \[i, Enter\], Exit \[e\]"
      send "i\r"
      sleep 20
      expect "Yes \[y, Enter\], No \[n\]"
      send "y\r"
      sleep 10
      expect eof
      '
    user: root
  
  createDB:
      cmd[${nodes.sqldb.master.id}]: PGPASSWORD=${nodes.sqldb.password} psql -Uwebadmin postgres -c "CREATE DATABASE ${globals.DB_NAME} WITH ENCODING 'UNICODE' LC_COLLATE 'C' LC_CTYPE 'C' TEMPLATE template0;"

startPage: https://${env.domain}
  
success: /texts/${globals.success}
